#!/bin/bash
#
# DO NOT REMOVE THESE LINES:
#
# d498b009f2fbae14a1e9ec984610a9fd20686afc
#
# FAST HOOK CHECKSUM: db12eef1cafa2f0b8e180a42d03bfd8b
#
# GENERATED BY SubGit version 3.3.7 build 4325
#

# computes absolute path from relative.
function abs_path() {
  pushd "$PWD" &>/dev/null

  local file="${1%/}"
  local result="$2"
  local file_basename="${file##*/}"
  local file_parent="${file%$file_basename}"
  if [ "x$file_parent" != "x" ]; then
    cd "$file_parent"
  fi
  local abs_file_parent="$(pwd -P)"
  local abs_file_parent_with_basename="$abs_file_parent/$file_basename"
  abs_file="${abs_file_parent_with_basename}"
  eval $result="'$abs_file'"

  popd &>/dev/null
}

cygwin=false
os400=false
darwin=false
case "`uname`" in
CYGWIN*) cygwin=true;;
OS400*) os400=true;;
Darwin*) darwin=true;;
esac

PRG="$0"
while [ -h "$PRG" ]; do
  ls=`ls -ld "$PRG"`
  link=`expr "$ls" : '.*-> \(.*\)$'`
  if expr "$link" : '/.*' > /dev/null; then
    PRG="$link"
  else
    PRG=`dirname "$PRG"`/"$link"
  fi
done

abs_path "$(dirname "$PRG")" SCRIPT_DIR
abs_path "$(dirname "$SCRIPT_DIR")" GIT_REPOS

GIT_REPOS="${GIT_REPOS%/.}"

export JAVA_HOME="/C/Program Files/Java/JDK8_64/jre"
JAVA_EXE="$JAVA_HOME/bin/java.exe"
JAVA_OPTIONS="-noverify -Xint -Djava.awt.headless=true -Djna.nosys=true"
MAIN_CLASS=org.tmatesoft.translator.SubGitHook
TS_CLASSPATH="$SCRIPT_DIR/../subgit/lib/subgit-3.3.7_4325_fat.jar"

# For Cygwin, switch paths to Windows format before running java
if $cygwin; then
  export JAVA_HOME=`cygpath --absolute --windows "$JAVA_HOME"`
  JAVA_EXE=`cygpath --absolute --windows "$JAVA_EXE"`
  PID_FILE=`cygpath --absolute --windows "$PID_FILE"`
  GIT_REPOS=`cygpath --absolute --windows "$GIT_REPOS"`
  SVN_REPOS=`cygpath --absolute --windows "$SVN_REPOS"`
  TS_CLASSPATH=`cygpath --path --windows "$TS_CLASSPATH"`
fi

abs_path "$(dirname "$0")" HOOKS_DIRECTORY

# echo
# echo "SubGit 3.3.7 build 4325: post-receive hook"
# echo "Current working directory: $PWD"
# echo "Java executable: $JAVA_EXE"
# echo "Java options: $JAVA_OPTIONS"
# echo "Java classpath: $TS_CLASSPATH"
# echo "Git repository: $GIT_REPOS"
# echo "Git hooks directory: $HOOKS_DIRECTORY"
# echo

HOOK_INPUT=$(cat)

# echo "Hook Input:"
# echo $HOOK_INPUT
# echo

USER_HOOKS_PREFIX="user"
USER_HOOK="$HOOKS_DIRECTORY/$USER_HOOKS_PREFIX-$(basename "$0")"
USER_HOOK_EXIT_CODE=0

if [ -x "$USER_HOOK" ] ; then
    # echo "Running user-post-receive"
    echo "$HOOK_INPUT" | "$USER_HOOK" "$@"
    USER_HOOK_EXIT_CODE=$?
    # echo "Exit code of user-post-receive: $USER_HOOK_EXIT_CODE"
fi

ARGUMENTS=""

umask 0022

C_HOOKS_PREFIX="fast"
C_HOOK_EXTENSION=".exe"
C_HOOK="$HOOKS_DIRECTORY/$C_HOOKS_PREFIX-$(basename "$0")$C_HOOK_EXTENSION"

if [ -x "$C_HOOK" ] ; then
    # echo "Running native post-receive hook"
    echo "$HOOK_INPUT" | "$C_HOOK"
else
    echo "$HOOK_INPUT" | "$JAVA_EXE" $JAVA_OPTIONS -cp "$TS_CLASSPATH" $MAIN_CLASS post-receive "$GIT_REPOS" $ARGUMENTS
    # echo "Running Java post-receive hook"
fi
SUBGIT_HOOK_EXIT_CODE=$?

if [ "$USER_HOOK_EXIT_CODE" != 0 ] ; then
    exit "$USER_HOOK_EXIT_CODE"
fi

exit "$SUBGIT_HOOK_EXIT_CODE"
